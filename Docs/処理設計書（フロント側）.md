# 処理設計書（フロント側）

## フェーズA：分析要求〜結果表示

---

## 0. 前提

* フロントは**チャットUI中心の単一画面**
* 画面遷移なし
* フロントは判断しない（分析可否・フェーズ制御はバックエンド）
* フロントの責務は以下に限定

  * 入力受付
  * 状態表示
  * バックエンドとの橋渡し

---

## 1. 初期表示処理

### 1.1 画面ロード時

**ユーザーからの見え方**

* チャット画面が表示される
* 「今週の重賞レース」欄が表示される（ボタン）

**フロント処理**

1. 画面初期化
2. チャット履歴の空表示
3. レース選択ボタン群を表示

**RAG / MCP / Agent 対応**

* 該当なし（純UI処理）

---

## 2. レース選択処理（分析トリガー）

### 2.1 ユーザーがレースボタンをクリック

**ユーザーからの見え方**

* 選択したレース名がチャットに表示される（例：「フェブラリーSを分析」）

**フロント処理**

1. レースID（またはレース名）を内部状態に保存
2. チャットに分析開始メッセージを表示
3. バックエンドへ分析要求イベントを送信

**送信イベント（概念）**

* event_type: ANALYSIS_REQUEST
* race_id
* phase: A

**RAG / MCP / Agent 対応**

* Agent起動のトリガー送信のみ

---

## 3. 分析中表示処理

### 3.1 バックエンド応答待ち

**ユーザーからの見え方**

* 「分析中です…」の表示
* ローディング表示

**フロント処理**

1. 入力を一時無効化
2. ローディング表示ON
3. 応答待ち状態へ遷移

**RAG / MCP / Agent 対応**

* バックエンド側でRAG・Agentが稼働
* フロントは待機のみ

---

## 4. 分析結果受信処理

### 4.1 分析結果レスポンス受信

**受信データ（概念）**

* race_info
* horse_results[]（horse_name / score / matched_conditions[]）
* conditions_summary[]

**ユーザーからの見え方**

* 分析完了メッセージ
* 各馬のスコア・順位
* 根拠（条件・母数・割合）

**フロント処理**

1. ローディングOFF
2. 分析結果をチャット形式に整形
3. 以下の順で表示

   * 分析完了メッセージ
   * レース概要
   * 各馬の分析結果
4. 内部状態に分析済みレース情報を保存

**RAG / MCP / Agent 対応**

* 表示内容はRAG結果＋Agent推論結果

---

## 5. 追加質問受付（フェーズA内）

### 5.1 ユーザーが追加質問を入力

**ユーザーからの見え方**

* 通常のチャット入力

**フロント処理**

1. 入力文をチャットに表示
2. フォローアップ質問イベントを送信

   * race_id
   * 直前分析コンテキスト
   * ユーザー質問文

**RAG / MCP / Agent 対応**

* Agentが既存分析を参照し、必要に応じてRAG再参照

---

## 6. フェーズ境界の扱い

* フロントはフェーズを自動切替しない
* 買い目入力UIは自動表示しない
* フェーズB関連UIは、バックエンドから明示許可が出た場合のみ表示

---

## 7. フロント処理フロー（テキスト）

[画面表示]
↓
[レース選択]
↓
[分析要求送信]
↓
[分析中表示]
↓
[分析結果受信]
↓
[結果表示]
↓
[追加質問 or 終了]

---

## 8. フロント側責務まとめ

| 項目     | フロント      |
| ------ | --------- |
| 分析判断   | ×         |
| データ取得  | ×         |
| RAG制御  | ×         |
| 推論     | ×         |
| 状態保持   | ○（会話状態のみ） |
| 表示     | ○         |
| フェーズ制御 | ×（許可反映のみ） |
