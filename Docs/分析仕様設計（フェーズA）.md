# 分析仕様設計（フェーズA）【確定】

要件（**嘘なし／母数・割合必須／単条件＋複合条件／年別→中央値／直近5走**）を満たすための、**分析ロジック設計**をここで固定する。

---

## 1. 入力と前提

### 1.1 入力データ（分析に使う事実）

* 対象レース：フェブラリーS
* 過去10年：各年1レース、**全頭**のレース結果

  * 必須属性：着順、枠、人気/オッズ、馬体重、上がり3F順位、斤量、馬齢、性別、父系統、母父系統、生産牧場、前走情報（格・着順・間隔）
* 今年の出馬表：同じ属性

  * 当日時点で不明な項目は**欠損**として扱う（推定しない）

### 1.2 目的変数（成功判定）

* `Y=1`：3着以内
* `Y=0`：4着以下

---

## 2. 条件（根拠）の定義設計

「根拠＝条件」。**機械的に定義可能**な単位に落とす。

### 2.1 単条件（atomic condition）

単条件は**カテゴリ or 区間**に正規化する（表記揺れ禁止）。

* 枠：`1` … `8`
* 人気帯：`1` / `2-3` / `4-6` / `7+`
* オッズ帯：`<=3.9` / `4.0-9.9` / `10-19.9` / `20+`
* 馬体重帯：後述のビニング
* 上がり3F：**順位**で扱う → `1-3` / `4-6` / `7+`
* 馬齢：`4` / `5` / `6` / `7+`
* 性別：`牡` / `牝` / `セ`
* 父系統／母父系統：系統名（例：ミスプロ系 等）
* 生産牧場：上位Nは個別、その他は`その他`
* 前走格：`G1/G2/G3/OP/3勝C以下/地方重賞/地方その他`
* 前走着順帯：`1-3` / `4-6` / `7-9` / `10+`
* ローテ（前走からの間隔）：`<=3週` / `4-6週` / `7-10週` / `11週+`
* 距離経験：`ダ1600経験あり/なし`
* コース経験：`東京経験あり/なし`
* 騎手（束ね）：上位N＋`その他`
* 調教師（束ね）：上位N＋`その他`

---

## 3. 直近5走の扱い（仕様）

直近5走は**履歴から機械算出**する。複雑化しない。

派生特徴（最小セット）：

* `近5走_最高格`（G1含むか等）
* `近5走_3着内回数`：`0/1/2/3+`
* `近5走_平均着順`：ビニング `<=3.9 / 4.0-6.9 / 7.0+`
* `近5走_ダ1600経験あり`：YES/NO
* `近5走_東京経験あり`：YES/NO

---

## 4. ビニング（区間切り）仕様

### 4.1 馬体重

* 過去10年分布を基に**20kg刻み**を基本（例：440–459、460–479…）
* 各区間の母数が薄い場合、**隣接区間を自動マージ**
* 母数下限は後述（ガードレール参照）

### 4.2 上がり3F

* **順位**のみ使用（秒は馬場差が強いため不採用）
* 取得不可は`欠損`扱い（条件に使わない）

---

## 5. 複合条件（AND）生成仕様【確定】

### 5.1 生成ルール

* 複合は **ANDのみ**
* 次数は **最大2**（2条件まで）

### 5.2 生成方式（確定）

* **単軸16（確定済み）**のうち、**独立軸同士**を用いる
* **全列挙（全探索）**で2軸ペアを生成
* 「前走格・前走着順・前走人気」など**同一文脈の派生を2軸扱いしない**
* 生成後、**3着内率基準**で採否を決める（作る前に殺さない）

---

## 6. 傾向（勝率＝3着内率）の算出仕様

### 6.1 母数の定義（必須表示）

* `N_all`：過去10年の全出走馬のうち条件該当数
* `N_top3`：過去10年の**3着内30頭**のうち条件該当数

### 6.2 割合の定義

* 表示必須：`N_top3 / 30` と `%`
* スコア用：

  * `rate_3in = (#条件満たす馬のうち3着内) / (#条件満たす馬)`

### 6.3 年別→中央値（代表値）

* 年 `y` ごとに
  `rate_y(c) = (#条件満たす馬のうち3着内) / (#条件満たす馬)`
* 代表値：
  `median_rate(c) = median_y rate_y(c)`
  （外れ年の歪み抑制）

### 6.4 採否基準（確定）

* **複合条件の採用基準：3着内率 ≥ 25%**
* 母数が小さい条件は**注記必須**（参考扱い可、除外しない）

---

## 7. 馬スコアリング仕様

### 7.1 基本形

* 馬 `h` が満たす条件集合 `C(h)`（単＋複合、採用条件のみ）
* 正規化スコア：

```
score(h) = (Σ w(c) * median_rate(c)) / (Σ w(c))
```

* 表示は `0–100`

### 7.2 重み w(c)（固定方針）

* **母数**と**安定性**で決める（恣意排除）

  * `f(N_all)`：母数が大きいほど重い（例：log）
  * `g(IQR)`：年別ばらつきが大きいほど軽い
* 数式の細部は後工程だが、**方針は固定**

---

## 8. 「嘘を言わない」ガードレール【確定】

* 欠損は**使わない**（推定しない）
* 母数が小さい条件は**生成するが注記**、重みで自然減衰
* **3条件以上の複合は禁止**
* 表示する母数・割合は**必ず再計算で一致確認**

---

## 9. フェーズAの成果物（次工程）

1. **条件カタログ**（単条件一覧＋ビニング定義）
2. **複合条件一覧**（独立2軸・全列挙・25%採否結果）
3. **スコア計算仕様**（重み方針・正規化・出力フォーマット）
