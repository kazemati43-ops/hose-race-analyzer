# 処理設計書（バックエンド側）

## フェーズA：分析要求〜結果返却

---

## 0. 前提（バックエンドの立場）

* バックエンドは**唯一の判断主体**
* フロントは要求送信のみを行う
* 嘘防止・検証仕様はすべてバックエンド責務
* 状態はAIではなくDBで保持する

---

## 1. 分析要求受付

### 1.1 フロントイベント受信

**入力**

* event_type: ANALYSIS_REQUEST
* race_id
* phase: A

**処理**

1. リクエスト妥当性検証（race_id / phase）
2. 分析セッションIDを発行
3. DBに分析セッションを生成

   * session_id
   * race_id
   * phase = A
   * status = ANALYSIS_RUNNING
   * created_at
4. 以降の処理は session_id をキーに進行

**状態管理**

* 本時点で「分析状態」が生成される
* 以降の再試行・検証・フォローアップは必ず session_id を参照

**対応役割**

* Agent：フェーズA分析開始判断
* MCP的役割：分析対象スコープの起点確定

---

## 2. 分析スコープ確定（MCP相当）

### 2.1 データ利用計画構築

**処理**

1. race_id から対象レース情報を特定
2. 過去10年分の分析対象を確定
3. 使用データ種別を固定（結果・馬属性・直近5走）

**対応役割**

* MCP：どのデータを文脈として使うかを決定

---

## 3. 過去データ取得（RAG）

### 3.1 DB検索

**処理**

1. 過去10年分の対象レース結果取得
2. 各年の全出走馬データ取得
3. 条件算出に必要な属性を全取得

**制約**

* 欠損値は補完しない
* 推定は禁止

**対応役割**

* RAG：事実データの取得（Retrieval）

---

## 4. 条件評価・傾向算出

### 4.1 単条件評価

**処理**

1. 条件カタログをロード
2. 条件ごとに年別3着内率算出
3. 年別値から中央値を算出

### 4.2 複合条件評価

**処理**

1. 許可された複合条件ペアのみ生成
2. 単条件と同様に母数・中央値を算出

**対応役割**

* Agent：評価順制御・母数不足条件の除外

---

## 5. 今年の出馬表への適用

### 5.1 条件適合判定

**処理**

1. 今年の出馬表取得
2. 各馬について条件適合判定
3. 適合条件集合を作成

### 5.2 スコア算出

**処理**

1. 条件中央値3着内率取得
2. 重み（母数・安定性）反映
3. 正規化スコア算出

---

## 6. 検証処理（嘘防止・分岐制御）

### 6.1 整合性検証

**検証内容**

* 条件母数と実データ一致確認
* 割合・中央値の再計算一致確認
* 欠損値を含む条件が混入していないか
* 条件生成ルール違反（未許可複合条件）がないか

### 6.2 分岐処理（重要）

**すべての検証を通過した場合**

* 処理を継続し、結果保存へ進む

**1つでも失敗した場合**

1. 分析セッション状態を以下に更新

   * status = ANALYSIS_FAILED
   * failure_reason を保存
2. 分析結果は保存しない
3. フロントへ以下を返却

   * 分析不可
   * 理由（仕様違反／母数不足等）

**設計思想**

* 検証失敗時は「部分結果」を返さない
* 嘘・推測・未検証値をユーザーに見せない

**対応役割**

* Agent：出力可否の最終判断

---

## 7. 結果構造化・保存

### 7.1 DB保存

**保存内容**

* 分析セッションID
* 使用条件一覧
* 各馬スコア
* 条件母数・割合
* 実行日時

### 7.2 応答生成

**生成内容**

* レース概要
* 各馬のスコア・順位・根拠
* 条件サマリー

---

## 8. フロント返却

**返却イベント**

* event_type: ANALYSIS_RESULT
* analysis_session_id
* payload（構造化結果）

**状態遷移**

* ANALYSIS_RUNNING → ANALYSIS_DONE

---

## 9. 追加質問対応（フォローアップ・状態参照）

### 9.1 フォローアップ受信

**入力**

* analysis_session_id
* ユーザー質問文

**処理**

1. analysis_session_id をキーにDBから以下を取得

   * 分析状態（ANALYSIS_DONEであること）
   * 保存済み分析結果
2. 状態が ANALYSIS_DONE でない場合

   * フォローアップ不可としてエラー返却
3. 必要に応じて

   * 条件詳細の再集計（同一データ・同一条件のみ）

**制約**

* 新規分析は禁止
* 条件生成・スコア再計算は禁止
* 既存結果の説明・再提示のみ許可

**状態管理**

* 分析セッションは再利用する
* 新たな session は生成しない

**対応役割**

* Agent：質問意図解釈・説明生成
* RAG：保存済み数値・母数の再取得

---

## 10. バックエンド処理フロー（テキスト）

[分析要求受信]
↓
[分析スコープ確定(MCP)]
↓
[過去データ取得(RAG)]
↓
[条件評価]
↓
[今年馬への当てはめ]
↓
[スコア算出]
↓
[検証]
↓
[結果保存]
↓
[結果返却]

---

## 11. 役割整理

* RAG：過去10年の事実データ取得
* MCP的役割：分析文脈・データ利用範囲の固定
* Agent：フェーズ制御・条件適用・説明生成
