# 検証仕様書（フェーズA・たたき台）

本仕様書は、フェーズAにおいて
**分析結果が「嘘を言っていない」「仕様どおりに算出されている」**ことを
機械的に検証するためのルールを定義する。

本検証は **精度（当たった／外れた）を評価しない**。
対象は **正当性・一貫性・再現性**のみとする。

---

## 1. 検証の基本方針

1. 検証は **自動化可能なもののみ**を対象とする
2. 人間の解釈を要する判断は禁止
3. 検証不能な分析結果は **不正（Fail）**とみなす
4. 検証結果は

   * Pass / Fail
   * Fail理由
     を必ず返す

---

## 2. 入力検証（データ仕様準拠チェック）

### 2.1 データ取得検証

以下を満たさない場合、分析は **実行不可（Fail）**。

* 対象レースが特定されている（フェブラリーS）
* 過去10年分の開催実体が揃っている
* 各年について **全頭分の出走データ**が存在する

---

### 2.2 欠損検証

* 欠損値（NULL）は許容するが、以下は禁止：

  * 欠損値を条件判定に使用
  * 欠損値を推定・補完して使用
* 欠損を含む条件が根拠として出力されていないことを検証する

Fail条件：

* 欠損を含む条件が

  * 条件成立
  * スコア寄与
    に使われている

---

## 3. 条件生成検証

### 3.1 単条件検証

* 単条件はすべて **仕様書で定義されたカテゴリ／区間のみ**で構成される
* 未定義カテゴリの条件が生成されていないこと

Fail条件：

* 定義外の条件名・区間が出力されている

---

### 3.2 複合条件検証

以下をすべて満たす必要がある。

* 条件数は **最大2**
* 結合は **ANDのみ**
* 同一文脈（例：前走格×前走着順）の組み合わせを含まない

Fail条件：

* 3条件以上の複合
* OR条件
* 禁止ペアの検出

---

## 4. 母数・割合検証（核心）

### 4.1 母数整合性検証

各条件 `c` について：

* 出力された

  * `N_top3`
  * `N_all`
    が、元データから再計算した値と一致すること

Fail条件：

* 母数の不一致
* 分母が不明な割合表示

---

### 4.2 割合計算検証

* 表示用割合：`N_top3 / 30`
* スコア用割合：`rate_3in`

両者が混同されていないことを検証する。

Fail条件：

* 分母が不明な％
* 30頭基準と条件母数基準の混在

---

## 5. 年別→中央値検証

### 5.1 年別算出検証

* 各条件 `c` について：

  * 年ごとの `rate_y(c)` が算出されている
* 年が欠けていないこと

Fail条件：

* 年別値が未算出
* 年数不足（10年未満）

---

### 5.2 中央値検証

* `median_rate(c)` が

  * 年別 `rate_y(c)` から
  * 正しく中央値として計算されている

Fail条件：

* 平均値を使用
* 中央値計算ミス

---

## 6. 採否基準検証

* 複合条件の採用基準は **3着内率 ≥ 25%**
* 未満の条件が：

  * 採用されていない
  * または「参考」と明示されている

Fail条件：

* 25%未満条件が無注記で採用されている

---

## 7. スコア計算検証

### 7.1 正規化検証

* スコアは **0–100**の範囲に収まる
* 条件数が多いだけでスコアが暴騰していない

Fail条件：

* 正規化されていないスコア
* 条件数依存の加算のみ

---

### 7.2 重み検証

* 重みは：

  * 母数
  * 安定性（ばらつき）
    に基づいている

Fail条件：

* 固定値重み
* 恣意的係数の混入

---

## 8. 出力検証（説明責任）

### 8.1 条件根拠ブロック

各条件に以下が必ず含まれる：

* 条件文
* `N_top3 / 30`
* 割合（%）

Fail条件：

* 数字なき「傾向」
* 言葉だけの根拠

---

### 8.2 馬別説明

各馬について：

* 総合スコア
* 適合条件一覧（数値付き）

Fail条件：

* スコアのみ提示
* 条件不明の評価

---

## 9. 検証結果の扱い

* Failが1つでもあれば：

  * 分析結果は **無効**
  * 予想・次工程への進行禁止
* Fail理由は必ず出力する

---

## 10. 本検証仕様のスコープ外

* 的中率評価
* 回収率評価
* 買い目生成
* フェーズB以降の検証
